<div id="status_info">
  <%= render(:partial => 'status')%>
</div>

<% content_for(:breadcrumb) do %>
  <%= breadcrumb_box do %>
    <%= link_to "Projects", projects_path %> &gt;
    Project <%= link_to current_project.name, current_project %> &gt;
    Stage <%= link_to current_stage.name, [current_project, current_stage] %> &gt;
    Deployment
  <% end %>
<% end %>

<% content_for(:page_title) do %>
  <% @page_title = "Deployment of stage #{current_stage.name} of project #{current_project.name}" %>
  <h2>Deployment: <%= link_to @deployment.task, [current_project, current_stage, @deployment] %></h2>
<% end %>

<% content_for(:page_scripts) do %>

  <script type="text/javascript">

    function check_auto_scroll_log(){
      var scroller = $("auto_scroll_log");
      var bottom_marker = $('back_link_at_the_bottom');

      if(scroller && scroller.checked && bottom_marker){
        bottom_marker.scrollTo();
      }
    }

    function scroll_to_top(){
      if ( $('auto_scroll_log').checked ){
        $('auto_scroll_log').checked = false;
      }

      $('header').scrollTo();
    }
    
  <% unless @deployment.completed? -%>
    function update_status(callback){
      var params = {
        random_differentiator: Math.floor(Math.random()*50000), // work around IE caching bug
        auto_scroll: $('auto_scroll_log').checked
      };
      $.get('<%= project_stage_deployment_path(@project, @stage, @deployment) %>.js', params, function(html){
        $('#status_info').html(html);
        check_auto_scroll_log();
        if(typeof callback == "function") callback();
      });
    }
    
    function loop_status(){
      if(!$('#auto_scroll_log').data('completed')){
        setTimeout(function(){
          update_status(loop_status);
        }, 3000);
      }
    }
    
    $(function(){
      check_auto_scroll_log();
      loop_status();
    });
  <% end -%>
  </script>

<% end %>
